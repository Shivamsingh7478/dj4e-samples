{% extends 'base_bootstrap.html' %}

{% block content %}
<h1>{% if form.instance.pk %}Edit Ad{% else %}Create Ad{% endif %}</h1>

<form method="post" enctype="multipart/form-data" id="upload_form">
    {% csrf_token %}
    {{ form.as_p }}
    <div id="file_size_message" style="display: none; margin: 10px 0; padding: 10px; border-radius: 5px;"></div>
    <input type="submit" value="Submit">
</form>

<script>
    console.log('JavaScript loaded for file size validation');
    
    // File size validation function
    function validateFileSize(file) {
        var maxSize = 2 * 1024 * 1024; // 2MB
        console.log('Validating file size:', file.size, 'bytes');
        
        var messageDiv = document.getElementById('file_size_message');
        var fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        
        if (file.size > maxSize) {
            messageDiv.innerHTML = '<div style="color: red; background-color: #ffe6e6; border: 1px solid #ff9999; padding: 10px; border-radius: 5px;">❌ File size (' + fileSizeMB + ' MB) exceeds the maximum allowed size of 2 MB. Please select a smaller file.</div>';
            messageDiv.style.display = 'block';
            return false;
        } else {
            messageDiv.innerHTML = '<div style="color: green; background-color: #e6ffe6; border: 1px solid #99ff99; padding: 10px; border-radius: 5px;">✅ File size (' + fileSizeMB + ' MB) is within the allowed limit of 2 MB.</div>';
            messageDiv.style.display = 'block';
            return true;
        }
    }

    // Check file size when file is selected
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, setting up file validation');
        var fileInput = document.querySelector('input[name="picture"]');
        console.log('Found file input:', fileInput);
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                console.log('File selected:', this.files[0]);
                if (this.files.length > 0) {
                    var file = this.files[0];
                    validateFileSize(file);
                    if (!validateFileSize(file)) {
                        this.value = '';
                        document.getElementById('file_size_message').innerHTML = '<div style="color: red; background-color: #ffe6e6; border: 1px solid #ff9999; padding: 10px; border-radius: 5px;">❌ File rejected. Please select a file smaller than 2 MB.</div>';
                    }
                } else {
                    document.getElementById('file_size_message').style.display = 'none';
                }
            });
        }
    });

    // Check file size before form submission
    document.getElementById("upload_form").addEventListener('submit', function(e) {
        console.log('Form submission attempted');
        var fileInput = document.querySelector('input[name="picture"]');
        if (fileInput && fileInput.files.length > 0) {
            var file = fileInput.files[0];
            if (!validateFileSize(file)) {
                e.preventDefault();
                return false;
            }
        }
        return true;
    });
</script>
{% endblock %}
